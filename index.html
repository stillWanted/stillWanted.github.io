<!doctype html>
<html>
<head>
<title>Top albums sortis en 2020</title>
<script src="https://code.jquery.com/jquery-3.5.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.js"></script>
<script src="jquery.lineProgressbar.js"></script>
<link rel="stylesheet" href="jquery.lineProgressbar.css" />
</head>
<body>
<script>
function check1(item,index){
	var check2020 = false
	var nom = item.name
	var artiste = item.artist.name
	var myUrl = "https://ws.audioscrobbler.com/2.0/?method=album.getinfo&user=stillWanted&api_key=270fbe267c5929d405f0efc2734291ef&artist="+artiste+"&album="+nom+"&format=json"
	$.ajax({
		url: myUrl,
		dataType: 'json',
		async: false,
		success: function(json){
			console.log(json)
			check2020 = json.album.tags.tag.some(item => item.name == 2020) || new Date(json.album.releasedate).getFullYear()==2020
			console.log("Check 1, "+item.name+" : " + check2020)
			console.log(index*100/$('#id1').val())
			$('#demoprogressbar1').LineProgressbar({
				percentage: index*100/$('#id1').val()
			});
		}
	});
	return check2020
}

function check2(item){
	var check2020 = false
	if(item.mbid!==""){
		var myUrl = "https://musicbrainz.org/ws/2/release/"+item.mbid+"?fmt=json"
		$.ajax({
			url: myUrl,
			dataType: 'json',
			async: false,
			success: function(json2){
				console.log(json2)
				console.log(json2["release-events"][0].date)
				console.log(json2["release-events"][0].date.split("-")[0])
				check2020 = json2["release-events"][0].date.split("-")[0] === '2020'
				console.log("Check 2, "+item.name+" : " + check2020)
		}
		});
	}
	return check2020
}

function process(item,index) { 
  setTimeout(function() {
		var check = false
		console.log(item.name)
		console.log(item.artist.name)
		check = check1(item,index)
		if(check===false){
			check = check2(item)
		}
		if(check){
			$('#result').append("<p><a href=" + item.url + " target='_blank'>" + item.artist.name + " : " + item.name + " - " + "Scrobbles : " +item.playcount + "</a></p>");
		}
  }, 1000 * index); 
} 

function getData() {
	$('#progressbar1').LineProgressbar(); 
	var url = "https://ws.audioscrobbler.com/2.0/?method=user.gettopalbums&period=12month&user="+$('#id2').val()+"&api_key=270fbe267c5929d405f0efc2734291ef&format=json&limit="+$('#id1').val()
    $.getJSON(url, function(json) {
		let index = 0
        console.log(json)
        $.each(json.topalbums.album, function(i, item) {
			process(item,index)
			index++
        });
    });
}
</script>
<div id="progressbar1"></div>
<p>Analyser mes <input id="id1" type="number" required> albums les + écoutés ces 12 derniers mois</p>
<p>Votre pseudo Last.fm:</p>
<input id="id2" type="text" required>
<button onclick="getData()">OK</button>
<div id="result"></div>
</body>
</html>